# PostgreSQL 15 - Configuración Nodo Primario
# Proyecto: Sistema Alta Disponibilidad - Pollo Sanjuanero S.A.

#------------------------------------------------------------------------------
# CONEXIONES Y AUTENTICACIÓN
#------------------------------------------------------------------------------

# Permite conexiones desde cualquier IP
listen_addresses = '*'
port = 5432
max_connections = 100

# Configuración SSL (deshabilitado para desarrollo)
ssl = off

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE REPLICACIÓN
#------------------------------------------------------------------------------

# wal_level: Determina cuánta información se escribe en el WAL
# 'replica' es necesario para replicación streaming y hot standby
wal_level = replica

# archive_mode: Habilita el archivado de segmentos WAL
# 'on' permite que los segmentos WAL sean archivados para respaldos
archive_mode = on

# archive_command: Comando ejecutado para archivar cada segmento WAL
# Copia los archivos WAL a un directorio de backup para recuperación point-in-time
archive_command = 'cp %p /backups/wal_archive/%f'

# max_wal_senders: Número máximo de procesos de envío WAL concurrentes
# Cada réplica necesita un wal_sender, configuramos 3 para redundancia
max_wal_senders = 3

# wal_keep_size: Cantidad mínima de segmentos WAL a mantener
# 1GB asegura que las réplicas puedan recuperarse en caso de desconexión temporal
wal_keep_size = 1GB

# checkpoint_timeout: Tiempo máximo entre checkpoints automáticos
# Reduce la frecuencia para mejorar rendimiento, pero aumenta tiempo de recuperación
checkpoint_timeout = 15min

# checkpoint_completion_target: Fracción del intervalo de checkpoint para completar el checkpoint
# 0.9 distribuye la escritura a lo largo del 90% del intervalo
checkpoint_completion_target = 0.9

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE MEMORIA
#------------------------------------------------------------------------------

# shared_buffers: Memoria compartida para caché de páginas
shared_buffers = 256MB

# wal_buffers: Memoria para buffers WAL
wal_buffers = 16MB

# effective_cache_size: Estimación de memoria disponible para caché del SO
effective_cache_size = 1GB

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE LOGS
#------------------------------------------------------------------------------

# Habilita logging para monitoreo
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_min_messages = info
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# Log de replicación
log_replication_commands = on

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE RENDIMIENTO
#------------------------------------------------------------------------------

# maintenance_work_mem: Memoria para operaciones de mantenimiento
maintenance_work_mem = 128MB

# max_parallel_workers: Número máximo de workers paralelos
max_parallel_workers = 4

# max_parallel_workers_per_gather: Workers por operación de gather
max_parallel_workers_per_gather = 2

#------------------------------------------------------------------------------
# CONFIGURACIÓN ESPECÍFICA PARA ALTA DISPONIBILIDAD
#------------------------------------------------------------------------------

# synchronous_standby_names: Nombres de standbys síncronos
# Configuración para replicación síncrona (opcional, comentado para async)
# synchronous_standby_names = 'postgres-standby'

# hot_standby: Permite consultas en servidores standby
hot_standby = on

# max_standby_archive_delay: Tiempo máximo que una consulta puede ejecutar
# antes de ser cancelada por conflicto con recuperación desde archivo
max_standby_archive_delay = 30s

# max_standby_streaming_delay: Similar pero para streaming replication
max_standby_streaming_delay = 30s

# wal_receiver_timeout: Tiempo máximo sin recibir datos antes de timeout
wal_receiver_timeout = 60s

# wal_sender_timeout: Tiempo máximo sin enviar datos antes de timeout
wal_sender_timeout = 60s

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE BACKUP
#------------------------------------------------------------------------------

# full_page_writes: Escribe páginas completas después de checkpoint
# Necesario para recuperación confiable
full_page_writes = on

# wal_log_hints: Habilita logging de hints en WAL
# Útil para herramientas como pg_rewind
wal_log_hints = on